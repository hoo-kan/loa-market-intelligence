<script>
    let rawData = [], displayItems = [], fullDetailData = [], itemMappingTable = {};
    let currentMainCat = "", currentSub = "ì „ì²´", sortState = { key: 'price', asc: false };
    let myChart = null;
    let currentViewMode = 'GOLD';
    let currentQuotes = 7000;
    let refreshInterval = null;
    const REFRESH_TIME = 5 * 60 * 1000; // 5ë¶„ (ë°€ë¦¬ì´ˆ)

    const crosshairPlugin = {
        id: 'crosshair',
        afterDraw: (chart) => {
            if (chart.tooltip?._active?.length) {
                const { ctx, chartArea: { top, bottom, left, right } } = chart;
                const activePoint = chart.tooltip._active[0];
                const x = activePoint.element.x; const y = activePoint.element.y;
                ctx.save(); ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.lineWidth = 1;
                ctx.strokeStyle = 'rgba(168, 85, 247, 0.4)';
                ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.moveTo(left, y); ctx.lineTo(right, y);
                ctx.stroke(); ctx.restore();
            }
        }
    };

    const getKrDay = (label) => {
        const match = label.match(/\(([^)]+)\)/);
        if (!match) return label;
        const engDay = match[1];
        const map = { 'Sun': 'ì¼', 'Mon': 'ì›”', 'Tue': 'í™”', 'Wed': 'ìˆ˜', 'Thu': 'ëª©', 'Fri': 'ê¸ˆ', 'Sat': 'í† ' };
        return label.replace(engDay, map[engDay] || engDay);
    };

    window.onload = () => {
        google.script.run.withSuccessHandler(map => {
            itemMappingTable = map;
            initNav();
            startAutoRefresh();
            setupKeyboardAccess(); // [P2] í‚¤ë³´ë“œ ì ‘ê·¼ì„± ì´ˆê¸°í™”
        }).getItemCategoryMap();
    };

    /**
     * [P2 Improvement] í‚¤ë³´ë“œ ì ‘ê·¼ì„± ì„¤ì •
     * - ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
     */
    function setupKeyboardAccess() {
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('chartModal');
                if (modal.style.display === 'block') {
                    closeModal();
                }
            }
        });
    }

    function initNav() {
        google.script.run.withSuccessHandler(configs => {
            const nav = document.getElementById('main-nav');
            // ëŒ€ì‹œë³´ë“œ ë²„íŠ¼ ìƒì„±
            const dashBtn = createNavBtn("DASHBOARD", () => { toggleView(true); loadDashboard(); });
            nav.appendChild(dashBtn);

            // ë‚˜ë¨¸ì§€ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ìƒì„±
            Object.keys(configs).forEach(cat => {
                nav.appendChild(createNavBtn(cat, () => { toggleView(false); renderSubNav(configs[cat]); loadData(cat); }));
            });

            // [í•µì‹¬] ì²« ë¡œë”© ì‹œ ëŒ€ì‹œë³´ë“œë¥¼ í™œì„±í™”í•˜ê³  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜´
            dashBtn.classList.add('nav-active');
            toggleView(true); // ë·° ì „í™˜ ë¨¼ì €
            loadDashboard();  // ë°ì´í„° ë¡œë“œ
        }).getConfig();
    }

    /**
     * 5ë¶„ë§ˆë‹¤ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ê°±ì‹ í•˜ëŠ” íƒ€ì´ë¨¸
     */
    function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);

        refreshInterval = setInterval(() => {
            // í˜„ì¬ í™œì„±í™”ëœ ë·°ì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ë¡œë“œ
            const dashView = document.getElementById('dashboard-view');
            const isDashVisible = dashView && (dashView.style.display === 'grid' || !dashView.classList.contains('hidden'));
            console.log(`â° ì •ê¸° ë°ì´í„° ê°±ì‹  (${isDashVisible ? 'ëŒ€ì‹œë³´ë“œ' : 'ë¦¬ìŠ¤íŠ¸'}) - ${new Date().toLocaleTimeString()}`);

            if (isDashVisible) {
                loadDashboard(); // ëŒ€ì‹œë³´ë“œ ê°±ì‹ 
            } else if (currentMainCat) {
                loadData(currentMainCat); // í˜„ì¬ ë³´ê³  ìˆëŠ” ì¹´í…Œê³ ë¦¬ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            }
        }, REFRESH_TIME);
    }

    function updateRefreshTimestamp(serverTime) {
        const timeElement = document.getElementById('update-time');
        if (!timeElement) return;

        timeElement.innerText = serverTime || new Date().toLocaleTimeString('ko-KR', { hour12: false });;
        // ì‹œê°ì  í”¼ë“œë°±: ê°±ì‹ ë  ë•Œ ì‚´ì§ ë°˜ì§ì´ê²Œ ì²˜ë¦¬ (Tailwind í™œìš©)
        timeElement.classList.add('text-white');
        setTimeout(() => timeElement.classList.remove('text-white'), 500);
    }

    function createNavBtn(text, onClick) {
        const btn = document.createElement('button');
        btn.innerText = text; btn.className = "pb-3 px-1 main-btn hover:text-white transition-all font-black uppercase tracking-tighter text-xs";
        btn.onclick = (e) => {
            document.querySelectorAll('.main-btn').forEach(b => b.classList.remove('nav-active'));
            e.target.classList.add('nav-active');
            onClick();
        };
        return btn;
    }

    function toggleView(isDash) {
        document.getElementById('dashboard-view').style.display = isDash ? 'grid' : 'none';
        document.getElementById('dashboard-summary').classList.toggle('hidden', !isDash);
        document.getElementById('table-view-container').classList.toggle('hidden', isDash);
        if (isDash) document.getElementById('sub-nav').innerHTML = '';
    }

    /**
     * ë©”ì¸ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ë¶„ì„ ì§€ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    function loadDashboard() {
        const gList = document.getElementById('gainer-list'), lList = document.getElementById('loser-list');

        // 1. UI í”¼ë“œë°± (ìŠ¤ì¼ˆë ˆí†¤ ë˜ëŠ” ë¶ˆíˆ¬ëª…ë„ ì¡°ì ˆ)
        if (gList.children.length === 0 || gList.innerHTML.includes('skeleton')) {
            gList.innerHTML = lList.innerHTML = `
          <div class="p-8 text-center text-slate-600 w-full">
            <div class="skeleton h-24 rounded-2xl w-full mb-4"></div>
            <p class="text-[10px] animate-pulse font-black uppercase tracking-widest">ë¶„ì„ ì—”ì§„ ê°€ë™ ì¤‘...</p>
          </div>`;
        } else {
            // ìë™ ê°±ì‹  ì‹œì—ëŠ” ë¶€ë“œëŸ¬ìš´ ë¶ˆíˆ¬ëª…ë„ íš¨ê³¼ë§Œ ì ìš©
            gList.style.opacity = lList.style.opacity = "0.5";
        }

        google.script.run.withSuccessHandler(data => {
            gList.style.opacity = lList.style.opacity = "1";
            updateRefreshTimestamp(data.updateTime);

            if (!data || data.totalCount === 0) {
                gList.innerHTML = lList.innerHTML = `
            <div class="p-8 text-center text-slate-500 text-xs">
              ìœ ì˜ë¯¸í•œ ì‹œì¥ ì‹ í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>`;
                return;
            }

            // 2. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (Progressive Rendering)
            gList.style.opacity = '0';
            lList.style.opacity = '0';
            gList.innerHTML = renderDashItems(data.gainers, 'rose');
            lList.innerHTML = renderDashItems(data.losers, 'blue', true);

            // Frame request for smooth fade-in
            requestAnimationFrame(() => {
                gList.style.transition = 'opacity 0.5s ease-out';
                lList.style.transition = 'opacity 0.5s ease-out';
                gList.style.opacity = '1';
                lList.style.opacity = '1';
            });

            // 3. ê¸°ì¡´ ëŒ€ì‹œë³´ë“œ ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            updateDashboardSummary(data);

            // 4. [ì¶”ê°€] ì‹œì¥ ë™ì¡°í™” ì§€ìˆ˜(Synergy Index) í†µí•© ë¶„ì„
            const allSignals = [...(data.gainers || []), ...(data.losers || [])];
            if (allSignals.length > 0) {
                updateSynergyIndex(allSignals);
            }
        }).getDashboardData();
    }

    function updateDashboardSummary(data) {
        const all = [...data.gainers, ...data.losers];
        if (all.length === 0) {
            document.getElementById('sentiment-label').innerText = "NO DATA";
            return;
        }

        const bullCount = data.gainers.filter(i => i.diff > 0).length;
        const bullRatio = Math.round((bullCount / all.length) * 100);

        document.getElementById('bull-bar').style.width = `${bullRatio}%`;
        document.getElementById('bear-bar').style.width = `${100 - bullRatio}%`;

        // ë¡œì•„ì‹ ê°ì„± ë¶„ì„: ì¬ë ¨ ì¬ë£Œ/ê°ì¸ì„œ ê°€ê²©ì´ ì˜¤ë¥´ë©´ 'ì‹œì¥ ê³¼ì—´'
        document.getElementById('sentiment-label').innerText = bullRatio > 60 ? "OVERHEAT" : (bullRatio < 30 ? "PANIC" : "STABLE");
        document.getElementById('sentiment-ratio').innerText = `${bullRatio}% UP / ${(100 - bullRatio)}% DOWN`;
        document.getElementById('total-items').innerText = `${data.totalCount} Core Items`;

        const hot = all.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff))[0];
        if (hot) document.getElementById('hot-item').innerText = `${hot.name} (${hot.diff > 0 ? '+' : ''}${hot.diff.toFixed(1)}%)`;
    }

    /**
     * ëŒ€ì‹œë³´ë“œ ì•„ì´í…œ ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜
     * @param {Array} items - í‘œì‹œí•  ì•„ì´í…œ ë°°ì—´
     * @param {string} color - í…Œë§ˆ ìƒ‰ìƒ (rose/blue)
     * @param {boolean} isFloor - ì €ì  ì—¬ë¶€
     * @returns {string} ìƒì„±ëœ HTML ë¬¸ìì—´
     */
    function renderDashItems(items, color, isFloor = false) {
        if (items.length === 0) return `<div class="p-8 text-center text-slate-600 text-xs">í˜„ì¬ ì¡°ê±´ì— ë§ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

        return items.map(item => {
            const absGap = Math.abs(item.gap);
            const isStrong = absGap >= 7.0; // 7% ì´ìƒ í™•ì‹¤í•œ ì‹ í˜¸
            const signalClass = isStrong ? `strong-signal-${color}` : '';
            const badge = isStrong ? `<span class="signal-badge bg-${color}-500 text-white animate-bounce">Strong</span>` : '';

            return `
          <div class="flex justify-between items-center p-5 bg-[#0f1115] rounded-2xl border border-slate-800 hover:border-${color}-500/50 cursor-pointer transition-all ${signalClass}" 
              onclick="showChart('${item.name}', '${item.sheet || item.cat}')">
            <div>
              <p class="text-[9px] text-slate-600 font-bold uppercase mb-0.5">${item.cat} ${badge}</p>
              <p class="font-bold text-slate-200">${item.name}</p>
            </div>
            <div class="text-right">
              <p class="font-mono font-bold text-white">${item.price.toLocaleString()} G</p>
              <p class="text-[11px] font-black text-${color}-500">
                Gap ${item.gap > 0 ? '+' : ''}${item.gap.toFixed(1)}%
              </p>
            </div>
          </div>`;
        }).join('');
    }

    /**
     * íŠ¹ì • ì¹´í…Œê³ ë¦¬ì˜ ë¦¬ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
     * @param {string} catName - SHEET_CONFIGì— ì •ì˜ëœ ë©”ì¸ ì¹´í…Œê³ ë¦¬ëª…
     */
    function loadData(catName) {
        currentMainCat = catName;
        const tableBody = document.getElementById('table-body');
        if (tableBody) tableBody.style.opacity = "0.6";

        google.script.run.withSuccessHandler(data => {
            if (tableBody) tableBody.style.opacity = "1";
            rawData = data;
            filterData(currentSub);
            const itemsForAnalysis = data.items || data;
            if (Array.isArray(itemsForAnalysis)) updateSynergyIndex(itemsForAnalysis);
            updateRefreshTimestamp(data.updateTime);
        }).getListData(catName);
    }

    function filterData(sub) {
        currentSub = sub || "ì „ì²´";
        const latest = rawData[rawData.length - 1], prev = rawData[rawData.length - 2] || latest;
        displayItems = Object.keys(latest).filter(h => h !== "ì¼ê°„")
            .filter(name => currentSub === "ì „ì²´" || (itemMappingTable[currentSub] || []).some(k => name.includes(k.trim())))
            .map(name => {
                const price = latest[name], history = rawData.slice(-7).map(d => d[name] || price);
                const avg7 = history.reduce((a, b) => a + b, 0) / history.length;
                return { name, price, prev: prev[name], diff: prev[name] === 0 ? 0 : ((price - prev[name]) / prev[name] * 100), gap: ((price - avg7) / avg7 * 100) };
            });
        sortData(sortState.key, true);
    }

    function sortData(key, isInitial = false) {
        if (!isInitial) {
            if (sortState.key === key) sortState.asc = !sortState.asc;
            else { sortState.key = key; sortState.asc = (key === 'name'); }
        }
        displayItems.sort((a, b) => {
            let v1 = a[key], v2 = b[key];
            if (typeof v1 === 'string') return sortState.asc ? v1.localeCompare(v2) : v2.localeCompare(v1);
            return sortState.asc ? v1 - v2 : v2 - v1;
        });

        // [P1] Smart Re-rendering: ì „ì²´ ë Œë”ë§ ëŒ€ì‹  Diffing (ê°„ì†Œí™” ë²„ì „)
        // 1. ê¸°ì¡´ í…Œì´ë¸”ì´ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ë Œë”ë§
        const tbody = document.getElementById('table-body');
        if (tbody.children.length === 0) {
            renderTable();
            return;
        }

        // 2. ì •ë ¬ì´ë‚˜ í•„í„°ë¡œ ì¸í•´ ìˆœì„œê°€ ë°”ë€ŒëŠ” ê²½ìš°:
        //    ê°„ë‹¨íˆ innerHTML êµì²´í•˜ë˜, ë°ì´í„° ë³€ê²½ ì‹œê°ì  í”¼ë“œë°±(Flash)ì€ ìœ ì§€í•˜ê¸° ì–´ë ¤ì›€.
        //    í•˜ì§€ë§Œ 'ê°’'ë§Œ ë°”ë€ŒëŠ” ê²½ìš°(Auto Refresh)ë¥¼ ìœ„í•´ id ë§¤ì¹­ ì‹œë„ ê°€ëŠ¥.
        //    ì—¬ê¸°ì„œëŠ” UI ë°˜ì‘ì„±ì„ ìœ„í•´ innerHTML ë°©ì‹ì„ ìœ ì§€í•˜ë˜ ë¶ˆí•„ìš”í•œ ë ˆì´ì•„ì›ƒ Thrashingì„ ì¤„ì´ê¸° ìœ„í•´
        //    requestAnimationFrame ë‚´ì—ì„œ ì²˜ë¦¬
        requestAnimationFrame(() => renderTable());
    }

    function renderTable() {
        document.getElementById('table-body').innerHTML = displayItems.map(item => {
            const isBubble = item.gap > 0;
            const signalColor = isBubble ? 'rose' : 'emerald';
            const signalLabel = isBubble ? 'ê±°í’ˆ(Exit)' : 'ì €ì (Dip)';
            const tooltipText = isBubble
                ? `í˜„ì¬ ì‹œì„¸ê°€ 7ì¼ í‰ê· ë³´ë‹¤ ${item.gap.toFixed(1)}% ë†’ìŠµë‹ˆë‹¤. ì¥ê¸° í•˜ë½ ì¤‘ ì¼ì‹œì  ë°˜ë“±ì¼ í™•ë¥ ì´ ë†’ìœ¼ë‹ˆ ì°½ê³  ì¬ê³  'ë§¤ë„'ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.`
                : `í˜„ì¬ ì‹œì„¸ê°€ 7ì¼ í‰ê· ë³´ë‹¤ ${Math.abs(item.gap).toFixed(1)}% ë‚®ìŠµë‹ˆë‹¤. ê·€ì† ì¬ë£Œë¥¼ 'ì‚¬ìš©'í•˜ê±°ë‚˜ 'ë§¤ìˆ˜'í•˜ê¸°ì— ê°€ì¥ íš¨ìœ¨ì ì¸ ì§€ì ì…ë‹ˆë‹¤.`;

            return `
        <tr class="hover:bg-[#1e222a] cursor-pointer group" onclick="showChart('${item.name}')">
          <td class="px-8 py-5 font-bold text-slate-300 group-hover:text-purple-400 transition-colors">${item.name}</td>
          <td class="px-8 py-5 text-right font-mono font-bold text-white">${item.price.toLocaleString()} G</td>
          <td class="px-8 py-5 text-right font-mono text-slate-500 text-xs">${item.prev.toLocaleString()} G</td>
          <td class="px-4 py-5 text-center">
            <div class="tooltip-trigger inline-block">
              <span class="px-2 py-1 rounded-md text-[9px] font-black min-w-[75px] bg-${signalColor}-500/10 text-${signalColor}-500">
                ${signalLabel} ${Math.abs(item.gap).toFixed(1)}%
              </span>
              <div class="tooltip-content"><strong>ğŸ’¡ ë¡œì•„ ë§ˆì¼“ ê°€ì´ë“œ</strong><br>${tooltipText}</div>
            </div>
          </td>
          <td class="px-8 py-5 text-center font-bold ${item.diff > 0 ? 'text-rose-500' : (item.diff < 0 ? 'text-blue-500' : 'text-slate-500')} text-[11px]">
            ${item.diff > 0 ? 'â–²' : (item.diff < 0 ? 'â–¼' : '')} ${Math.abs(item.diff).toFixed(2)}%
          </td>
        </tr>`;
        }).join('');
    }

    /**
     * ìƒì„¸ ì •ë³´ì°½(ëª¨ë‹¬)ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     * @param {string} name - ì•„ì´í…œëª…
     * @param {string} overrideCat - (ì„ íƒ) í˜¸ì¶œ ì‹œ ëª…ì‹œí•  ì¹´í…Œê³ ë¦¬/ì‹œíŠ¸ëª…
     */
    function showChart(name, overrideCat) {
        // ì „ì—­ ë³€ìˆ˜ currentMainCatë³´ë‹¤ ëª…ì‹œì ìœ¼ë¡œ ë„˜ì–´ì˜¨ overrideCatì„ ìš°ì„ í•¨
        const targetCat = overrideCat || currentMainCat;
        if (!targetCat) {
            console.error("ì¹´í…Œê³ ë¦¬ ì •ë³´ê°€ ì—†ì–´ ìš”ì²­ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.");
            return;
        }

        document.getElementById('modalTitle').innerText = name;
        const modal = document.getElementById('chartModal');
        const skeleton = document.getElementById('skeletonView');
        const realView = document.getElementById('realView');

        modal.style.display = 'block';
        skeleton.classList.remove('hidden');
        realView.classList.add('hidden', 'opacity-0'); // í˜ì´ë“œì¸ ì¤€ë¹„

        google.script.run.withSuccessHandler(detailData => {
            // ë¹ˆ ë°°ì—´ ì‘ë‹µ ì²˜ë¦¬ v2
            if (!detailData || detailData.length === 0) {
                alert("í•´ë‹¹ ì•„ì´í…œì˜ ìƒì„¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            fullDetailData = detailData; // ì „ì—­ ì €ì¥
            currentViewMode = 'GOLD'; // ë¦¬ì…‹
            currentQuotes = detailData.quotes;

            updateRealValue(
                detailData[detailData.length - 1].value,
                Math.max(detailData[detailData.length - 2].value, 1),
                detailData.quotes
            );
            changePeriod(0);

            skeleton.classList.add('hidden');
            realView.classList.remove('hidden');
            setTimeout(() => realView.classList.remove('opacity-0'), 50);

        }).withFailureHandler(err => {
            console.error(err);
            showToast("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + err.message, 'error');
            closeModal();
        }).getDetailData(targetCat, name);
    }

    function changePeriod(days) {
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.toggle('active', (days == 7 && btn.innerText == '7D') || (days == 30 && btn.innerText == '30D') || (days == 90 && btn.innerText == '90D') || (days == 0 && btn.innerText == 'ALL'));
        });
        const filtered = days === 0 ? fullDetailData : fullDetailData.slice(-days);
        renderChart(filtered.map(d => d.date), filtered.map(d => d.value));
    }

    function updateDynamicStats() {
        if (!myChart) return;
        const isRealMode = currentViewMode === 'REAL';
        const x = myChart.scales.x, startIdx = Math.max(0, Math.floor(x.min)), endIdx = Math.min(myChart.data.labels.length - 1, Math.ceil(x.max));
        const p = myChart.data.datasets[0].data.slice(startIdx, endIdx + 1), labels = myChart.data.labels.slice(startIdx, endIdx + 1);
        if (p.length < 2) return;

        const cur = p[p.length - 1], ma7 = p.length >= 7 ? p.slice(-7).reduce((a, b) => a + b, 0) / 7 : p.reduce((a, b) => a + b, 0) / p.length;
        const momentum = ((p[p.length - 1] * 0.6) + (p[p.length - 2] * 0.4)) / ((p[p.length - 2] * 0.6) + (p[p.length - 3] * 0.4 || 1)) - 1;
        const trendEl = document.getElementById('trend-signal'), badge = document.getElementById('sales-badge'), trendContent = document.getElementById('trend-content');

        let status = (momentum > 0.005 && cur > ma7) ? "EXIT" : ((momentum < -0.015) ? "CRASH" : "STABLE");

        if (status === "EXIT") {
            trendEl.className = "tooltip-trigger p-4 rounded-[22px] border border-rose-500/40 bg-[#0f1115] flex flex-col items-center justify-center min-h-[85px]";
            trendContent.innerHTML = `<span class="text-rose-500 text-[9px] font-black uppercase mb-1 tracking-[0.2em]">High Opportunity</span><span class="text-xl font-black text-white italic">EXIT</span>`;
            badge.innerText = "ë§¤ë„ ê¸°íšŒ"; badge.className = "px-2 py-0.5 rounded text-[9px] font-bold bg-rose-500/20 text-rose-500";
        } else if (status === "CRASH") {
            trendEl.className = "tooltip-trigger p-4 rounded-[22px] border border-blue-500/40 bg-[#0f1115] flex flex-col items-center justify-center min-h-[85px]";
            trendContent.innerHTML = `<span class="text-blue-500 text-[9px] font-black uppercase mb-1 tracking-[0.2em]">Fast Decay</span><span class="text-xl font-black text-white italic">CRASH</span>`;
            badge.innerText = "ê¸‰ë½ ìœ„í—˜"; badge.className = "px-2 py-0.5 rounded text-[9px] font-bold bg-blue-500/20 text-blue-500";
        } else {
            trendEl.className = "tooltip-trigger p-4 rounded-[22px] border border-slate-800 bg-[#0f1115] flex flex-col items-center justify-center min-h-[85px]";
            trendContent.innerHTML = `<span class="text-slate-500 text-[9px] font-black uppercase mb-1 tracking-[0.2em]">Default Drift</span><span class="text-xl font-black text-white italic">STABLE</span>`;
            badge.innerText = "ê´€ë§/ì‚¬ìš©"; badge.className = "px-2 py-0.5 rounded text-[9px] font-bold bg-slate-700 text-slate-300";
        }

        const dayStats = {}; labels.forEach((label, i) => {
            const match = label.match(/\(([^)]+)\)/); if (match) {
                let d = match[1]; const map = { 'Sun': 'ì¼', 'Mon': 'ì›”', 'Tue': 'í™”', 'Wed': 'ìˆ˜', 'Thu': 'ëª©', 'Fri': 'ê¸ˆ', 'Sat': 'í† ' };
                d = map[d] || d; if (!dayStats[d]) dayStats[d] = { sum: 0, count: 0 }; dayStats[d].sum += p[i]; dayStats[d].count++;
            }
        });
        let bestDayStr = "--", maxAvg = 0; Object.keys(dayStats).forEach(d => { const avg = dayStats[d].sum / dayStats[d].count; if (avg > maxAvg) { maxAvg = avg; bestDayStr = d + "ìš”ì¼"; } });
        document.getElementById('best-day').innerText = bestDayStr;
        document.getElementById('momentum-val').innerText = (momentum > 0 ? "+" : "") + (momentum * 100).toFixed(1) + "%";

        const fmt = (num) => isRealMode ? num.toFixed(2) : Math.round(num).toLocaleString();
        const max = Math.max(...p), min = Math.min(...p), avg = Math.round(p.reduce((a, b) => a + b, 0) / p.length);
        document.getElementById('stat-cards').innerHTML = `
        <div class="bg-[#0f1115] p-4 rounded-2xl border border-slate-800 text-center"><p class="text-[9px] text-rose-500 font-black mb-1 uppercase opacity-60">Peak</p><p class="text-lg font-black font-mono text-white">${fmt(max).toLocaleString()}</p></div>
        <div class="bg-[#0f1115] p-4 rounded-2xl border border-slate-800 text-center"><p class="text-[9px] text-blue-500 font-black mb-1 uppercase opacity-60">Floor</p><p class="text-lg font-black font-mono text-white">${fmt(min).toLocaleString()}</p></div>
        <div class="bg-[#0f1115] p-4 rounded-2xl border border-slate-800 text-center"><p class="text-[9px] text-slate-500 font-black mb-1 uppercase opacity-60">Avg</p><p class="text-lg font-black font-mono text-white">${fmt(avg).toLocaleString()}</p></div>
        <div class="bg-purple-500/10 p-4 rounded-2xl border border-purple-500/30 text-center"><p class="text-[9px] text-purple-400 font-black mb-1 uppercase">Latest</p><p class="text-lg font-black font-mono text-white">${fmt(cur).toLocaleString()}</p></div>`;
        document.getElementById('modalPeriod').innerText = `Range: ${getKrDay(labels[0])} ~ ${getKrDay(labels[labels.length - 1])}`;
    }

    /**
     * ì„¹í„° ë‚´ ì•„ì´í…œë“¤ì˜ í‰ê·  Gapì„ ê³„ì‚°í•˜ì—¬ ì‹œì¥ ë¶„ìœ„ê¸°ë¥¼ ìƒì„¸í™”í•¨
     */
    function updateSynergyIndex(items) {
        const targets = ['main-synergy-index', 'synergy-index'];
        if (!items || items.length === 0) return;

        const avgGap = items.reduce((acc, item) => acc + parseFloat(item.gap || 0), 0) / items.length;
        let status = 'STABLE', color = 'text-slate-400', icon = 'âš–ï¸';

        if (avgGap > 4.5) { status = 'HOT'; color = 'text-rose-400'; icon = 'ğŸ”¥'; }
        else if (avgGap < -4.5) { status = 'PANIC'; color = 'text-blue-400'; icon = 'ğŸ˜¨'; }

        const htmlContent = `<span class="${color} font-black uppercase">${icon} ${status} (${avgGap > 0 ? '+' : ''}${avgGap.toFixed(1)}%)</span>`;

        targets.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = htmlContent;
        });
    }

    /**
     * ì‹¤ì§ˆ ê°€ì¹˜ ê³„ì‚° ë° UI ì£¼ì…
     * @param {number} currentPrice - í˜„ì¬ ì•„ì´í…œ ê³¨ë“œ ê°€ê²©
     * @param {number} exchangeRate - í™”í ê±°ë˜ì†Œ ì‹œì„¸ (ì˜ˆ: 2850)
     */
    function updateRealValue(currentPrice, prevPrice, exchangeRate = 2850) {
        const el = document.getElementById('real-value-num');
        if (!el) return;

        // í™˜ì‚°: (ì•„ì´í…œê°€ê²© / í™˜ìœ¨) * 100 (100BCë‹¹ ê°€ê²© ê¸°ì¤€ì¼ ê²½ìš°)
        const currentBC = (currentPrice / exchangeRate) * 100;
        const prevBC = (prevPrice / exchangeRate) * 100;

        el.innerText = currentBC.toFixed(2);
        el.classList.add('animate-pulse');
        setTimeout(() => el.classList.remove('animate-pulse'), 1000);

        // ì‹œë‹ˆì–´ê¸‰ ì¸ì‚¬ì´íŠ¸: ê³¨ë“œëŠ” ì˜¬ëëŠ”ë° ì‹¤ì§ˆ ê°€ì¹˜ëŠ” ë–¨ì–´ì¡Œì„ ë•Œ ê²½ê³ 
        const goldDiff = ((currentPrice - prevPrice) / prevPrice) * 100;
        const bcDiff = ((currentBC - prevBC) / prevBC) * 100;
        if (goldDiff > 0 && bcDiff < -2) {
            console.warn("âš ï¸ ê³¨ë“œ ê°€ì¹˜ í•˜ë½ì— ì˜í•œ ì°©ì‹œ í˜„ìƒ ê°ì§€");
            // UIì— "ì¸í”Œë ˆ ì£¼ì˜" ë°°ì§€ ë“±ì„ ì¶”ê°€ë¡œ ë„ìš¸ ìˆ˜ ìˆìŒ
        }
    }

    /**
     * ì•„ì´í…œ ì‹œì„¸ ì°¨íŠ¸ ë° MA7 ì¶”ì„¸ì„ ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
     * @param {Array<string>} labels - ë‚ ì§œ ë°°ì—´
     * @param {Array<number>} prices - ê°€ê²© ë°°ì—´
     */
    function renderChart(labels, prices) {
        const ctx = document.getElementById('itemChart').getContext('2d');

        // [P1] Memory Leak Prevention: ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ë° ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        if (myChart) {
            myChart.destroy();
            myChart = null;
        }
        // Canvas Clear (ì”ìƒ ì œê±° ë° ë©”ëª¨ë¦¬ í•´ì œ ë„ì›€)
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        const bcRate = (currentQuotes && currentQuotes.BC_PER_GOLD) ? currentQuotes.BC_PER_GOLD : 7000;

        // 1. ëª¨ë“œì— ë”°ë¥¸ ë°ì´í„° ë³€í™˜ (GOLD or REAL)
        const isRealMode = currentViewMode === 'REAL';
        const displayPrices = isRealMode ? prices.map(p => (p / bcRate) * 100) : prices;
        const unit = isRealMode ? 'BC' : 'G';
        const themeColor = isRealMode ? '#10b981' : '#a855f7'; // ì—ë©”ë„ë“œ(REAL) vs í¼í”Œ(GOLD)
        const areaColor = isRealMode ? 'rgba(16, 185, 129, 0.05)' : 'rgba(168, 85, 247, 0.05)';

        // 1. MA7 (7-Day Moving Average) ë°ì´í„° ê³„ì‚°
        // const ma7Data = prices.map((_, idx, arr) => {
        //   const windowSize = 7;
        //   const start = Math.max(0, idx - windowSize + 1);
        //   const subset = arr.slice(start, idx + 1);
        //   const sum = subset.reduce((a, b) => a + b, 0);
        //   return subset.length > 0 ? (sum / subset.length) : null;
        // });

        // MA7 ê³„ì‚° v2
        const ma7Data = displayPrices.map((_, idx, arr) => {
            const windowSize = 6;
            const subset = arr.slice(Math.max(0, idx - windowSize), idx + 1);
            return subset.reduce((a, b) => a + b, 0) / subset.length;
        });

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                // datasets: [
                //   {
                //     // ë©”ì¸ ì‹œì„¸ ë°ì´í„°
                //     label: 'í˜„ì¬ ì‹œì„¸',
                //     data: prices,
                //     borderColor: '#a855f7',
                //     borderWidth: 3,
                //     pointRadius: 0,
                //     hoverRadius: 6,
                //     hoverBackgroundColor: '#a855f7',
                //     fill: true,
                //     backgroundColor: 'rgba(168, 85, 247, 0.05)',
                //     tension: 0.3,
                //     order: 1 // ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ìœ„ë¡œ ì˜¬ë¼ì˜´
                //   },
                //   {
                //     // MA7 ì¶”ì„¸ì„ 
                //     label: '7ì¼ í‰ê· (MA7)',
                //     data: ma7Data,
                //     borderColor: 'rgba(255, 255, 255, 0.3)', // ì°¨ë¶„í•œ íˆ¬ëª… í°ìƒ‰
                //     borderWidth: 1.5,
                //     borderDash: [5, 5], // ì ì„  ì²˜ë¦¬ë¡œ ë©”ì¸ ë°ì´í„°ì™€ êµ¬ë¶„
                //     pointRadius: 0,
                //     fill: false,
                //     tension: 0.4,
                //     order: 2
                //   }
                // ]
                datasets: [
                    // { 
                    //   label: 'í˜„ì¬ê°€',
                    //   data: prices,
                    //   borderColor: '#a855f7',
                    //   borderWidth: 3,
                    //   pointRadius: 0,
                    //   tension: 0.3,
                    //   fill: true,
                    //   backgroundColor: 'rgba(168, 85, 247, 0.05)',
                    //   order: 1
                    // },
                    {
                        label: isRealMode ? 'ì‹¤ì§ˆê°€ì¹˜(BC)' : 'í˜„ì¬ê°€(G)',
                        data: displayPrices,
                        borderColor: themeColor,
                        borderWidth: 3,
                        pointRadius: 0,
                        tension: 0.3,
                        fill: true,
                        backgroundColor: areaColor,
                        order: 1
                    },
                    {
                        label: isRealMode ? 'ì‹¤ì§ˆì¶”ì„¸(MA7)' : '7ì¼ í‰ê· (MA7)',
                        data: ma7Data,
                        borderColor: isRealMode ? 'rgba(16, 185, 129, 0.3)' : 'rgba(148, 163, 184, 0.4)',
                        borderWidth: 1.5,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0.4,
                        order: 2
                    },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    // 2. í¬ë¡œìŠ¤í—¤ì–´: ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— ë”°ë¼ ì‹­ì ê°€ì´ë“œë¼ì¸ í‘œì‹œ
                    crosshair: true,
                    // 3. íˆ´íŒ ì„¤ì •: ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ ë‚˜íƒ€ë‚˜ëŠ” ì •ë³´ì°½
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(15, 17, 21, 0.95)',
                        padding: 16,
                        cornerRadius: 16,
                        borderColor: themeColor + '40',
                        borderWidth: 1,
                        callbacks: {
                            title: (items) => getKrDay(items[0].label),
                            label: (ctx) => {
                                const label = ctx.dataset.label;
                                const value = ctx.raw;
                                // ì‹¤ì§ˆ ê°€ì¹˜ëŠ” ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€, ê³¨ë“œëŠ” ì •ìˆ˜ í‘œê¸°
                                const formattedValue = isRealMode ? value.toFixed(2) : Math.round(value).toLocaleString();
                                return ` ${label}: ${formattedValue} ${unit}`;
                            }
                        }
                    },
                    // tooltip: {
                    //   enabled: true,
                    //   backgroundColor: 'rgba(15, 17, 21, 0.95)',
                    //   padding: 16,
                    //   cornerRadius: 16,
                    //   borderColor: 'rgba(168, 85, 247, 0.3)',
                    //   borderWidth: 1,
                    //   displayColors: true, // ë°ì´í„°ì…‹ ìƒ‰ìƒ(ë³´ë¼ìƒ‰/íšŒìƒ‰) í‘œì‹œ
                    //   boxPadding: 6,
                    //   callbacks: {
                    //     // ì œëª©: ìš”ì¼ì´ í¬í•¨ëœ í•œêµ­ì–´ ë‚ ì§œ í‘œì‹œ
                    //     title: (items) => getKrDay(items[0].label),
                    //     // ë‚´ìš©: í˜„ì¬ê°€ì™€ MA7ì„ êµ¬ë¶„í•˜ì—¬ ì¶œë ¥
                    //     label: (ctx) => {
                    //       const label = ctx.dataset.label;
                    //       const value = ctx.raw;
                    //       // ìˆ«ìëŠ” ë°˜ì˜¬ë¦¼í•˜ì—¬ ì²œë‹¨ìœ„ ì½¤ë§ˆ í‘œì‹œ
                    //       return ` ${label}: ${Math.round(value).toLocaleString()} G`;
                    //     }
                    //   }
                    // },
                    // 4. ì¤Œ/íŒ¬ ì„¤ì •: ì°¨íŠ¸ í™•ëŒ€ ë° ì´ë™
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x', // ê°€ë¡œì¶• ê¸°ì¤€ í™•ëŒ€
                            onZoomComplete: () => updateDynamicStats() // í™•ëŒ€ í›„ í†µê³„ ì¹´ë“œ ê°±ì‹ 
                        },
                        pan: {
                            enabled: true,
                            mode: 'x',
                            onPanComplete: () => updateDynamicStats() // ì´ë™ í›„ í†µê³„ ì¹´ë“œ ê°±ì‹ 
                        }
                    }
                },
                scales: {
                    y: {
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: {
                            color: '#475569',
                            font: { size: 10 },
                            callback: (val) => isRealMode ? val.toFixed(1) : val.toLocaleString()
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            color: '#475569',
                            maxTicksLimit: 8,
                            font: { size: 10 },
                            callback: function (v) { return getKrDay(this.getLabelForValue(v)); }
                        }
                    }
                }
            },
            plugins: [crosshairPlugin]
        });

        updateDynamicStats();
    }

    function switchChartMode(mode) {
        currentViewMode = mode;

        // UI ìƒíƒœ ë³€ê²½
        const isGold = mode === 'GOLD';
        document.getElementById('btn-gold').className = `px-3 py-1.5 rounded-lg text-[9px] font-black ${isGold ? 'bg-slate-800 text-white' : 'text-slate-500'}`;
        document.getElementById('btn-real').className = `px-3 py-1.5 rounded-lg text-[9px] font-black ${!isGold ? 'bg-slate-800 text-white' : 'text-slate-500'}`;

        // ì°¨íŠ¸ ë¦¬ë Œë”ë§ (ë™ì¼ ë°ì´í„°ë¡œ í™˜ì‚° ì²˜ë¦¬)
        changePeriod(0);
    }

    function renderSubNav(config) {
        const s = document.getElementById('sub-nav');
        s.innerHTML = config.subs.map(sub => `<button onclick="handleSubClick(this, '${sub}')" class="sub-btn px-4 py-1.5 rounded-full bg-[#1c1f26] text-[10px] font-black border border-slate-700 text-slate-500 uppercase transition-all">${sub}</button>`).join('');
        const f = s.querySelector('.sub-btn'); if (f) f.classList.add('sub-active');
    }

    function handleSubClick(b, s) {
        document.querySelectorAll('.sub-btn').forEach(x => x.classList.remove('sub-active'));
        b.classList.add('sub-active');
        filterData(s);
    }

    function closeModal() {
        // [P1] Memory Leak Prevention: ëª¨ë‹¬ ë‹«ì„ ë•Œ ì°¨íŠ¸ íŒŒê´´
        if (myChart) {
            myChart.destroy();
            myChart = null;
        }
        document.getElementById('chartModal').style.display = 'none';
    }

    /**
     * [P0 Improvement] ì‚¬ìš©ì í”¼ë“œë°±ì„ ìœ„í•œ Toast ë©”ì‹œì§€ í‘œì‹œ
     * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
     * @param {string} type - 'error' | 'success'
     */
    function showToast(message, type = 'error') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerText = message;
        document.body.appendChild(toast);

        // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>